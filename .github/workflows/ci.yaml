#
# Copyright IBM Corporation 2020,2023
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Continuous Integration

on:
  push:
    branches: [ main ]
    tags: [ '*' ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  schedule:
    - cron: '30 11 * * 1,3,5'

permissions: read-all

jobs:
  ci-local:
    runs-on: ubuntu-22.04
    env:
      KAR_JAVA_SDK_OVERRIDE: -Dversion.kar-java-sdk=99.99.99-SNAPSHOT
    steps:
      # Checkout repo 
      - name: Checkout repo
        uses: actions/checkout@v3

      # Download pre-reqs
      - name: Install k8s clis
        run: ./ci/setup.sh

      # Configure language versions
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'core/go.mod'
          cache-dependency-path: 'core/go.sum'
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Setup JavaScript
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      # Deploy Kafka and Redis (do early, to increase odds of them being ready before the tests start)
      - name: Start Kafka and Redis
        run: ./scripts/docker-compose-start.sh

      # Build KAR locally
      - name: Make KAR cli
        run: make cli
      - name: Build Java SDK
        working-directory: sdk-java
        run: |
          mvn --batch-mode versions:set -DnewVersion=99.99.99-SNAPSHOT
          mvn --batch-mode install
      - name: Setup yalc to use local JavaScript SDK
        run: |
          npm i -g yalc
          ./scripts/setup-yalc.sh

      # Run tests
      - name: rpclib unit tests
        run: |
          . ./scripts/kar-env-local.sh
          make check-rpc
        shell: bash
      - name: Run JavaScript tests
        run: ./ci/testJSLocal.sh
      - name: Run Java tests
        run: ./ci/testJavaLocal.sh


  ci-local-released:
    runs-on: ubuntu-22.04
    steps:
      # Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # Download pre-reqs
      - name: Install k8s clis
        run: ./ci/setup.sh

      # Configure language versions
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'core/go.mod'
          cache-dependency-path: 'core/go.sum'
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Setup JavaScript
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      # Deploy Kafka and Redis (add a sleep because `make cli` is fast)
      - name: Start Kafka and Redis
        run: |
          ./scripts/docker-compose-start.sh
          sleep 5

      # Build KAR locally
      - name: Make KAR cli
        run: make cli

      # Run tests
      - name: Run JavaScript tests
        run: ./ci/testJSLocal.sh
      - name: Run Java tests
        run: ./ci/testJavaLocal.sh


  ci-in-cluster:
    runs-on: ubuntu-22.04
    steps:
      # Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # Download pre-reqs
      - name: Install k8s clis
        run: ./ci/setup.sh

      # Configure language versions
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'core/go.mod'
          cache-dependency-path: 'core/go.sum'
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
      - name: Setup JavaScript
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      # Start kind (need registry running to push images)
      - name: Start kind
        run: ./scripts/kind-start.sh

      # Build KAR locally
      - name: Make KAR cli
        run: make cli
      - name: Make JavaScript images
        run: make docker-js
      - name: Make Python images
        run: make docker-python

      # Delopy KAR on kind
      - name: Deploy KAR
        run: ./scripts/kar-k8s-deploy.sh

      # Run in cluster tests
      - name: Run Tests
        run: ./ci/testInCluster.sh
