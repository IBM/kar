<!--
# Copyright IBM Corporation 2020,2021
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
-->

# Using KARAMEL integrations from KAR.

This example uses Karamel to construct the source and sink components for the Stock Price example. The example is split into three components: source (HTTP service), sink (#kar-output Slack channel) and a user-defined Javascript component.

Since the simplest form of source/sink integration is used, the example leverages Karamel's capability to automatically generate and run the integration code that belongs to the source and sink integrations.

All three components are launched locally using KAR.

## Detailed description of the components.

The source uses a Camel reactive streams component to repeatedly request stock price updates from an external HTTP-based service. The stock information arrives in JSON format. The Karamerl integration code packs the data as a Cloud Event and forwards it to a user implemented processor launched using KAR. The communication between the input component and the user-defined component is done via the `InputStockEvent` Kafka topic.

The user-defined processor unpacks the cloud event, adds it to the list of existing stock prices, computes the maximum stock price seen so far and then assembles a Cloud Event which contains the output string to be printed in Slack. The cloud event is published on the `OutputStockEvent` Kafka topic.

The sink component receives the Cloud Event containing the output message and forward the message to the Slack kar-output channel.

The source and sink integrations use a combination of YAML configuration files and JAVA files for defining the to/from Cloud Event conversion of the messages.

## Steps to run the example

### Install KARAMEL

The Karamel project can be found here: https://github.ibm.com/solsa/karamel along with installation instructions.

### Set Slack channel details

For the consumer to output to a Slack channel, expose the incoming webhook address via the `KARAMEL_SLACK_WEBHOOK` environment variable.

Specify channel name (without #). For example:
```
export KARAMEL_SLACK_CHANNEL=kar-output
```

### Set Kafka broker details

Export the following environment variable (taken from kar-env-local.sh)
```
export KAFKA_BROKERS=localhost:31093
```

Move to the example folder:

```
cd examples/kar-karamel
```

Create topics for this example:

```
sh createTopics.sh
```

Since the KAR user-defined component is implemented in Javascript, run `npm`:

```
npm install
```

## Running the components

Run the sink component:
```
sh input.sh
```

Run the user-defined component:
```
sh run-user-code.sh
```

Run the source component:
```
sh output.sh
```

All the temporary files automatically generated by `karamel` will be dumped into the `input` and `output` folders (as specified by the `-workspace` flag passed to each of the input/output `karamel` commands respectively).
